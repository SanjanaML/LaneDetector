<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Lane Detector - Fixed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    
    <style>
        body { 
            margin: 0; 
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #startButton {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 25px 50px;
            font-size: 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 999;
        }
        
        #laneInfo {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-size: 24px;
            z-index: 998;
            text-align: center;
            display: none;
        }
        
        #cameraPreview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            object-fit: cover;
            display: none;
        }
        
        #arContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: none;
        }
    </style>
</head>
<body>
    <button id="startButton">Start AR Lane Detector</button>
    
    <video id="cameraPreview" autoplay playsinline muted></video>
    
    <div id="arContainer">
        <a-scene id="arScene" 
                 embedded 
                 vr-mode-ui="enabled: false"
                 background="transparent: true">
            
            <a-sky color="rgba(0,0,0,0)"></a-sky>
            
            <a-camera active="true" 
                      look-controls="false" 
                      cursor="rayOrigin: mouse"
                      position="0 0 0">
            </a-camera>
            
            <!-- Lane indicators -->
            <a-box id="goodLane" 
                   position="0 0 -2" 
                   width="3" height="0.5" depth="0.2"
                   color="#00FF00" 
                   opacity="0.9"
                   visible="false">
                <a-text value="GOOD LANE" 
                        align="center" 
                        position="0 0.3 0" 
                        color="#FFFFFF" 
                        width="10">
                </a-text>
            </a-box>
            
            <a-box id="badLane" 
                   position="0 0 -2" 
                   width="3" height="0.5" depth="0.2"
                   color="#FF0000" 
                   opacity="0.9"
                   visible="false">
                <a-text value="BAD LANE" 
                        align="center" 
                        position="0 0.3 0" 
                        color="#FFFFFF" 
                        width="10">
                </a-text>
            </a-box>
            
            <!-- Lighting -->
            <a-light type="ambient" color="#FFFFFF"></a-light>
            <a-light type="point" intensity="0.5" position="0 2 0"></a-light>
        </a-scene>
    </div>
    
    <div id="laneInfo">
        Lane Status: <span id="laneStatus">Scanning...</span>
    </div>
    
    <script>
        const startButton = document.getElementById('startButton');
        const cameraPreview = document.getElementById('cameraPreview');
        const arContainer = document.getElementById('arContainer');
        const laneInfo = document.getElementById('laneInfo');
        const goodLane = document.getElementById('goodLane');
        const badLane = document.getElementById('badLane');
        
        let video;
        let canvas;
        let isDetecting = false;
        
        startButton.addEventListener('click', startCamera);
        
        function startCamera() {
            startButton.style.display = 'none';
            
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                },
                audio: false
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    // Display camera preview
                    cameraPreview.srcObject = stream;
                    cameraPreview.style.display = 'block';
                    
                    // Wait for camera to start
                    cameraPreview.onloadedmetadata = () => {
                        // Show AR overlay
                        arContainer.style.display = 'block';
                        laneInfo.style.display = 'block';
                        
                        // Create canvas for processing
                        canvas = document.createElement('canvas');
                        canvas.width = cameraPreview.videoWidth;
                        canvas.height = cameraPreview.videoHeight;
                        
                        // Start detection
                        startDetection();
                    };
                })
                .catch(err => {
                    alert('Camera error: ' + err.message);
                    startButton.style.display = 'block';
                });
        }
        
        function startDetection() {
            isDetecting = true;
            
            function detect() {
                if (isDetecting && cameraPreview.readyState === cameraPreview.HAVE_ENOUGH_DATA) {
                    const context = canvas.getContext('2d');
                    context.drawImage(cameraPreview, 0, 0);
                    
                    const quality = analyzeLane(context);
                    updateDisplay(quality);
                }
                
                requestAnimationFrame(detect);
            }
            
            detect();
        }
        
        function analyzeLane(context) {
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let whitePixels = 0;
            let totalPixels = 0;
            
            // Check bottom half for bright areas
            for (let y = Math.floor(canvas.height / 2); y < canvas.height; y += 4) {
                for (let x = 0; x < canvas.width; x += 4) {
                    const i = (y * canvas.width + x) * 4;
                    const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
                    
                    if (brightness > 150) whitePixels++;
                    totalPixels++;
                }
            }
            
            const ratio = whitePixels / totalPixels;
            const isGood = ratio > 0.1;
            
            return {
                isGood: isGood,
                ratio: ratio
            };
        }
        
        function updateDisplay(quality) {
            // Update text
            document.getElementById('laneStatus').textContent = quality.isGood ? 'GOOD' : 'BAD';
            document.getElementById('laneStatus').style.color = quality.isGood ? '#00FF00' : '#FF0000';
            
            // Update 3D indicators
            goodLane.setAttribute('visible', quality.isGood);
            badLane.setAttribute('visible', !quality.isGood);
        }
    </script>
</body>
</html>
